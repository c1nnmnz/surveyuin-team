import{j as e,v as X,ao as Y,ag as Z,ap as q,C as z,ai as ee,K as se}from"./ui-components-E1kookGP.js";import{i as re,j as ie,r as b,L as E}from"./vendor-Bo00a0u0.js";import{u as te}from"./surveyStore-VDgMCFEy.js";import{u as ne}from"./index-CxZZOcZu.js";import{u as ae}from"./directoryStore-HDTwRuRx.js";import{surveyQuestions as M}from"./SurveyQuestion-Cn6yZbAB.js";import{p as le}from"./parseISO-B6o4a0-U.js";import{f as oe}from"./format-BWB-Nt1Y.js";import{i as ce}from"./id-DKsBABLi.js";import"./data-management-BXwEc-vo.js";import"./ui-framework-_byMagRW.js";import"./en-US-D9lzRxDE.js";const we=()=>{const{responseId:h}=re(),_=ie(),{allResponses:I,getResponsesForService:Q,isServiceCompleted:$}=te(),{user:de}=ne(),{getServiceById:A}=ae(),[v,B]=b.useState(null),[j,R]=b.useState(null),[F,K]=b.useState(!0),[r,P]=b.useState({overall:0,corruptionPerception:0,serviceQuality:0,surveyIntegrity:0,dimensions:{}}),[f,V]=b.useState({responses:!0,summary:!0,detailedScores:!1});b.useEffect(()=>{(()=>{K(!0);try{console.log("Fetching survey detail for serviceId:",h),console.log("All responses available:",I);const s=A(h);console.log("Service data from directory:",s);let t=[];if(typeof Q=="function"&&(t=Q(h),console.log("Responses from getResponsesForService:",t)),(!t||t.length===0)&&(t=I.filter(n=>n.serviceId===h),console.log("Responses from manual filtering:",t)),t.length>0){const n=t[t.length-1];console.log("Found latest response:",n),B(n);const a={corruption_perception:M.filter(l=>l.category==="corruption_perception"),service_quality:M.filter(l=>l.category==="service_quality"),survey_integrity:M.filter(l=>l.category==="survey_integrity")},d=[...a.corruption_perception,...a.service_quality,...a.survey_integrity],o=s?s.name:n.serviceName||"Survei Layanan";R({id:h,title:o,description:(s==null?void 0:s.description)||"Detail survei yang telah Anda isi untuk layanan ini.",questions:d,questionsByCategory:a}),O(n,a)}else{const n=$(h);if(console.log("Service completion status:",{isCompleted:n,serviceId:h}),!n)console.log("Survey not found, redirecting to history page"),_("/history");else{console.log("Service marked as completed but no response data found");const a=s?s.name:"Survei Layanan";R({id:h,title:a,description:"Detail respons survei tidak tersedia.",questions:[]})}}}catch(s){console.error("Error fetching survey details:",s)}finally{K(!1)}})()},[h,I,_,$,Q,A]);const O=(i,s)=>{if(!i||!i.answers||!s)return;const t=i.answers||[],n=s.corruption_perception||[],a=s.service_quality||[],d=s.survey_integrity||[],o=w(t,n),l=w(t,a),c=w(t,d),m={};if([...new Set(a.map(p=>p.dimension).filter(Boolean))].forEach(p=>{const g=a.filter(G=>G.dimension===p);m[p]=w(t,g)}),n.length>0&&Math.round(o)===100&&a.length>0&&Math.round(l)===100&&(d.length===0||Math.round(c)===100)){P({overall:100,corruptionPerception:o,serviceQuality:l,surveyIntegrity:c,dimensions:m});return}const x=n.filter(p=>t.some(g=>g.questionId===p.id&&g.answer)),N=a.filter(p=>t.some(g=>g.questionId===p.id&&g.answer)),S=d.filter(p=>t.some(g=>g.questionId===p.id&&g.answer)),k=x.length+N.length+S.length;if(k===0){P({overall:0,corruptionPerception:0,serviceQuality:0,surveyIntegrity:0,dimensions:m});return}const H=x.length/k,J=N.length/k,U=S.length/k;let u=0;x.length>0&&(u+=o*H),N.length>0&&(u+=l*J),S.length>0&&(u+=c*U),(x.length===0||o>=99)&&(N.length===0||l>=99)&&(S.length===0||c>=99)&&u>99&&(u=100),u=Math.round(u*100)/100,(x.length===0||o>99.5)&&(N.length===0||l>99.5)&&(S.length===0||c>99.5)&&u>99.5&&(u=100),P({overall:u,corruptionPerception:o,serviceQuality:l,surveyIntegrity:c,dimensions:m})},w=(i,s)=>{if(!s.length)return 0;const t=s.filter(l=>i.some(c=>c.questionId===l.id&&c.answer));if(!t.length)return 0;let n=0,a=0,d=!0;if(t.forEach(l=>{const c=i.find(x=>x.questionId===l.id);if(!c)return;const m=parseInt(c.answer);if(isNaN(m))return;const L=6;m<L&&(d=!1),n+=m,a+=L}),d&&a>0)return 100;const o=a>0?n/a*100:0;return Math.round(o*100)/100},C=i=>{V(s=>({...s,[i]:!s[i]}))},T=(i,s)=>{if(!i.options)return s;const t=i.options.find(n=>n.value===s||n.label===s);return t?t.label:s},W=i=>{if(!i)return"-";try{const s=typeof i=="string"?le(i):i;return oe(s,"dd MMMM yyyy",{locale:ce})}catch(s){return console.error("Date formatting error:",s),String(i)}},y=i=>i>=80?"text-green-600":i>=60?"text-blue-600":i>=40?"text-yellow-600":"text-red-600",D=(i,s="overall")=>{const t={overall:{excellent:"Sangat baik! Anda memberikan penilaian sangat positif pada layanan ini.",good:"Baik. Anda memberikan penilaian cukup positif pada layanan ini.",average:"Cukup. Anda memberikan penilaian netral pada layanan ini.",poor:"Kurang baik. Anda memberikan penilaian cenderung negatif pada layanan ini."},corruptionPerception:{excellent:"Sangat baik! Layanan ini memiliki tingkat persepsi korupsi yang sangat rendah.",good:"Baik. Layanan ini memiliki tingkat persepsi korupsi yang rendah.",average:"Cukup. Layanan ini memiliki tingkat persepsi korupsi yang moderat.",poor:"Perhatian! Layanan ini memiliki tingkat persepsi korupsi yang tinggi."},serviceQuality:{excellent:"Sangat memuaskan! Kualitas layanan ini sangat baik.",good:"Baik. Kualitas layanan ini cukup memuaskan.",average:"Cukup. Kualitas layanan ini dalam kategori standar.",poor:"Perlu ditingkatkan. Kualitas layanan ini masih di bawah standar."}},n=t[s]||t.overall;return i>=80?n.excellent:i>=60?n.good:i>=40?n.average:n.poor};return F?e.jsx("div",{className:"min-h-[70vh] flex items-center justify-center",children:e.jsx("div",{className:"w-16 h-16 border-4 border-t-blue-500 border-b-blue-500 border-l-transparent border-r-transparent rounded-full animate-spin"})}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs(E,{to:"/history",className:"inline-flex items-center text-primary-600 hover:text-primary-800 mb-6",children:[e.jsx(X,{size:16,className:"mr-1"}),"Kembali ke Riwayat Survei"]}),j?e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white shadow-md rounded-lg p-6",children:[e.jsx("h1",{className:"text-2xl font-display font-bold text-secondary-900 mb-2",children:j.title}),e.jsx("p",{className:"text-secondary-600 mb-4",children:j.description}),v&&e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 md:gap-8 mt-4",children:[e.jsxs("div",{className:"flex items-center text-secondary-600",children:[e.jsx(Y,{size:18,className:"mr-2"}),e.jsxs("span",{children:["Diisi pada: ",W(v.completedAt)]})]}),e.jsxs("div",{className:"flex items-center text-green-600",children:[e.jsx(Z,{size:18,className:"mr-2"}),e.jsx("span",{children:"Status: Selesai"})]}),e.jsx("div",{className:"flex items-center text-secondary-900 font-medium",children:e.jsxs("span",{children:["Skor: ",e.jsxs("span",{className:y(r.overall),children:[Math.round(r.overall),"%"]})]})})]})]}),v&&r.overall>0&&e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-primary-50 cursor-pointer",onClick:()=>C("summary"),children:[e.jsx("h2",{className:"text-lg font-medium text-secondary-900",children:"Ringkasan Analisis"}),f.summary?e.jsx(q,{size:20}):e.jsx(z,{size:20})]}),f.summary&&e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-secondary-900 mb-2",children:"Skor Keseluruhan"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4",children:e.jsx("div",{className:`h-4 rounded-full ${r.overall>=80?"bg-green-500":r.overall>=60?"bg-blue-500":r.overall>=40?"bg-yellow-500":"bg-red-500"}`,style:{width:`${r.overall}%`}})}),e.jsxs("span",{className:`font-medium ${y(r.overall)}`,children:[Math.round(r.overall),"%"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-secondary-900 mb-2",children:"Interpretasi"}),e.jsx("div",{className:"p-4 bg-gray-50 rounded-lg",children:e.jsx("p",{className:y(r.overall),children:D(r.overall)})})]}),e.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-secondary-900",children:"Skor Detail"}),e.jsxs("button",{onClick:i=>{i.stopPropagation(),C("detailedScores")},className:"inline-flex items-center text-primary-600 hover:text-primary-800",children:[e.jsx(ee,{size:18,className:"mr-2"}),e.jsx("span",{children:f.detailedScores?"Sembunyikan Detail":"Lihat Detail"})]})]}),f.detailedScores&&e.jsxs("div",{className:"mt-4 space-y-6",children:[r.corruptionPerception>0&&e.jsxs("div",{className:"border border-gray-100 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-secondary-900 mb-2",children:"Persepsi Korupsi"}),e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx("div",{className:`h-3 rounded-full ${r.corruptionPerception>=80?"bg-green-500":r.corruptionPerception>=60?"bg-blue-500":r.corruptionPerception>=40?"bg-yellow-500":"bg-red-500"}`,style:{width:`${r.corruptionPerception}%`}})}),e.jsxs("span",{className:`font-medium ${y(r.corruptionPerception)}`,children:[Math.round(r.corruptionPerception),"%"]})]}),e.jsx("p",{className:`text-sm ${y(r.corruptionPerception)}`,children:D(r.corruptionPerception,"corruptionPerception")})]}),r.serviceQuality>0&&e.jsxs("div",{className:"border border-gray-100 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-secondary-900 mb-2",children:"Kualitas Layanan"}),e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx("div",{className:`h-3 rounded-full ${r.serviceQuality>=80?"bg-green-500":r.serviceQuality>=60?"bg-blue-500":r.serviceQuality>=40?"bg-yellow-500":"bg-red-500"}`,style:{width:`${r.serviceQuality}%`}})}),e.jsxs("span",{className:`font-medium ${y(r.serviceQuality)}`,children:[Math.round(r.serviceQuality),"%"]})]}),e.jsx("p",{className:`text-sm ${y(r.serviceQuality)}`,children:D(r.serviceQuality,"serviceQuality")})]}),r.surveyIntegrity>0&&e.jsxs("div",{className:"border border-gray-100 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-secondary-900 mb-2",children:"Integritas Survei"}),e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx("div",{className:`h-3 rounded-full ${r.surveyIntegrity>=80?"bg-green-500":r.surveyIntegrity>=60?"bg-blue-500":r.surveyIntegrity>=40?"bg-yellow-500":"bg-red-500"}`,style:{width:`${r.surveyIntegrity}%`}})}),e.jsxs("span",{className:`font-medium ${y(r.surveyIntegrity)}`,children:[Math.round(r.surveyIntegrity),"%"]})]})]})]})]})]}),v&&j.questions.length>0&&e.jsxs("div",{className:"bg-white shadow-md rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-primary-50 cursor-pointer",onClick:()=>C("responses"),children:[e.jsx("h2",{className:"text-lg font-medium text-secondary-900",children:"Respons Anda"}),f.responses?e.jsx(q,{size:20}):e.jsx(z,{size:20})]}),f.responses&&e.jsx("div",{className:"p-4",children:Object.entries(j.questionsByCategory||{}).map(([i,s])=>{if(!s||s.length===0||!s.some(a=>{var d;return(d=v.answers)==null?void 0:d.some(o=>o.questionId===a.id)}))return null;const n=i==="corruption_perception"?"Persepsi Korupsi":i==="service_quality"?"Kualitas Layanan":i==="survey_integrity"?"Integritas Survei":"Pertanyaan Lainnya";return e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-secondary-800 mb-3 pb-2 border-b border-gray-100",children:n}),e.jsx("div",{className:"divide-y divide-gray-200",children:s.map((a,d)=>{var c;const o=(c=v.answers)==null?void 0:c.find(m=>m.questionId===a.id),l=o?o.answer:null;return o?e.jsxs("div",{className:"py-4",children:[e.jsx("p",{className:"font-medium text-secondary-900 mb-2",children:a.text}),e.jsx("div",{className:"mt-2",children:a.options?e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"font-medium mr-2",children:"Jawaban:"}),e.jsxs("span",{className:"bg-primary-50 py-1 px-3 rounded-full text-primary-700",children:[T(a,l)," (",l,")"]})]}),e.jsx("div",{className:"w-full max-w-xs mt-2 sm:mt-0",children:e.jsx("div",{className:"h-2 bg-gray-200 rounded-full",children:e.jsx("div",{className:"h-2 bg-primary-500 rounded-full",style:{width:`${parseInt(l)/6*100}%`}})})})]}):e.jsxs("div",{children:[e.jsx("span",{className:"font-medium mr-2",children:"Jawaban:"}),e.jsx("p",{className:"mt-1 bg-gray-50 p-3 rounded text-secondary-800",children:l||"-"})]})})]},a.id):null})})]},i)})})]})]}):e.jsxs("div",{className:"bg-white shadow-md rounded-lg p-8",children:[e.jsxs("div",{className:"flex items-center text-yellow-600 mb-4",children:[e.jsx(se,{size:24,className:"mr-2"}),e.jsx("p",{children:"Detail survei tidak ditemukan."})]}),e.jsx(E,{to:"/history",className:"btn-primary",children:"Kembali ke Riwayat Survei"})]})]})};export{we as default};
